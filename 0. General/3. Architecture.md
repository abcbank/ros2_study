# Architecture
## 1. Nodes
- C++/Python으로 이루어진 하나의 객체
- 별도의 프로그램으로 생각하면 됨
- ROS 2 자체의 컨셉은 여러 개의 프로그램이 통신을 통해 담당한 영역을 제어하는 것
- 각 노드는 통신을 통해 다른 노드에서 데이터를 받거나, 보낼 수 있음.
  - 이때 사용되는 통신의 형태에 따라 Topics/Services/Actions/Parameters 네 가지 형태로 분리

![ROS2_Concept](../Assets/Image/0_ROS2_Concept.gif)

## 2. Topic
- Subscriber / Publisher를 활용한 통신 방식
- 하나의 Topic에 대해 여러개의 Subscriber / Publisher를 묶을 수 있음
- Topic에 대한 메세지를 Publisher가 송신할 경우, Topic은 개시된 값을 Publisher에게 송신된 값으로 변경
- 주기적으로 메세지를 송신해야하는 경우 사용
  - 센서 데이터
  - 라이더 데이터 등등

![ROS2_Concept](../Assets/Image/0_Topic_Concept.gif)

### 2.1. Subscribers
- Topic을 구독하는 기능
- 지정된 Topic에 개시된 정보를 전달받아 이를 가공해 활용할 수 있도록 보조

### 2.2. Publishers
- Topic을 개시하는 기능
- Topic이 개시하고 있는 데이터의 값을 변경

## 3. Service
- Server / Client를 활용한 통신 방식
- Client에서 데이터를 요청하고, Server가 이를 응답하는 방식으로 구성
- Topic과 달리 요청을 할 경우에만 응답

![ROS2_Concept](../Assets/Image/0_Service_Concept.gif.gif)

### 3.1. Service Client
- Service Server에 데이터를 요청

### 3.2. Publishers
- Service Client의 요청에 응답

## 4. Parameters
- 노드의 설정들을 파라미터라 명명
- integers / floats / booleans / strings / lists 사용 가능
- 모든 노드들은 생성자에서 파라미터가 명확하게 정의되어있어야 함.
- 일부 파라미터가 선언되지 않은 노드를 사용할 경우, `allow_undeclared_parameters`를 `true`로 설정해야 함
- 실행 도중 선언된 파라미터의 타입을 변경할 경우 에러 발생
  - 실행 도중 boolean 타입 파라미터를 interger로 변경
- 각 파라미터는 변경 전 / 변경 후 콜백 함수를 호출
  - set_parameter: 매개변수가 선언/변경 전 콜백 함수 호출
  - on_paramter_event: 매개변수가 선언/변경 후 콜백 함수 호출

### 4.1. Default Service
- 외부 프로세스에서 서비스를 통해 파라미터를 제어 가능
- 총 6개의 기본 서비스를 제공
  1. /`node_name`/`parameters` | `rcl_interfaces`/`srv`/`DescriptionParameters`
      - Input: 파라미터 이름 리스트
      - Output: 파라미터 상세 설명 리스트

  2. /`node_name`/`get_parameter_types` | `rcl_interfaces`/`srv`/`GetParameter`
      - Input: 파라미터 이름 리스트
      - Output: 파라미터 타입 리스트
  3. /`node_name`/`get_parameters` | `rcl_interfaces`/`srv`/`GetParameters`
      - input: 파라미터 이름 리스트
      - Output: 파라미터 값 리스트
  4. /`node_name`/`list_parameters` | `rcl_interfaces`/`srv`/`ListParameters`
      - Input: prefix 리스트
      - Output: prefix에 해당하는 파라미터 리스트. prefix가 없을 경우 모든 파라미터 리턴
  5. /`node_name`/`set_parameters` | `rcl_interfaces`/`srv`/`SetParameters`
      - Input: 파라미터 이름 및 값 리스트
      - Output: 실행 결과 리스트(Fail / Success)
  6. /`node_name`/`set_parameters_atomically` | `rcl_interfaces`/`srv`/`SetParameters`
      - Input: 파라미터 이름 및 값 리스트
      - Output: 하나의 실행 결과(Fail / Success)

### 4.2. 파라미터 기본 설정(Run)
1. 커멘드 라인 활용
> ros2 run package_name executable_name --ros-args -p param_name:=param_value

2. yaml 파일 활용
```yaml
parameter_blackboard:
    ros__parameters:
        some_int: 42
        a_string: "Hello world"
        some_lists:
            some_integers: [1, 2, 3, 4]
            some_doubles : [3.14, 2.718]
```

### 4.3. 파라미터 기본 설정(Launch)
1. LaunchDescription
```python
from launch import LaunchDescription
from launch.actions import DeclareLaunchArgument
from launch.substitutions import LaunchConfiguration, TextSubstitution

from launch_ros.actions import Node

def generate_launch_description():
   param_1_arg = DeclareLaunchArgument(
      'param_1', default_value=TextSubstitution(text='0')
   )
   param_2_arg = DeclareLaunchArgument(
      'param_1', default_value=TextSubstitution(text='84')
   )
   param_3_arg = DeclareLaunchArgument(
      'param_1', default_value=TextSubstitution(text='122')
   )

   return LaunchDescription([
      param_1_arg,
      param_2_arg,
      param_3_arg,
      Node(
         package='turtlesim',
         executable='turtlesim_node',
         name='sim',
         parameters=[{
            'param_1': LaunchConfiguration('param_1'),
            'param_2': LaunchConfiguration('param_2'),
            'param_3': LaunchConfiguration('param_3'),
         }]
      ),
   ])
```
2. yaml 파일 활용
``` python
import os

from ament_index_python.packages import get_package_share_directory

from launch import LaunchDescription
from launch_ros.actions import Node


def generate_launch_description():
   config = os.path.join(
      get_package_share_directory('pkg_name'),
      'config',
      'config.yaml'
      )

   return LaunchDescription([
      Node(
         package='pkg_name',
         executable='node_name',
         namespace='name_space',
         name='name',
         parameters=[config]
      )
   ])
```

## 5. Action
- Service / Topic을 활용해 작업을 시간이 오래 소모되는 작업을 수행
- 총 세가지 부분으로 분리
  - goal(Service)
  - feedback(Topic)
  - result(Service)

### 5.1. Sequence
1. Action Server에 goal 전달
2. Action Server에 result 전달
3. Action Server에서 feedback 스트리밍
4. 작업 완료 후 Action Client에 result 전달
